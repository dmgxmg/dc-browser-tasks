(()=>{"use strict";function t(t){return t.startsWith("//")?(s=t,document.evaluate(s,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue):(e=t,document.querySelector(e));var e,s}function e(t){const e={bubbles:!0},s=new TouchEvent("touchstart",e);t.dispatchEvent(s);const i=new TouchEvent("touchend",e);t.dispatchEvent(i)}let s=t=>{t.click()};function i(t){return new Promise((e=>setTimeout(e,t)))}async function a(e){let s=100;for(;;){const a=t(e);if(a)return a;if(--s<=0)return Promise.reject(`Wait for element timeout! Target: [${e}]`);await i(100)}}async function n(t){var e;(e=await a(t)).scrollIntoView({block:"center"}),s(e)}const o=Boolean(window.ReactNativeWebView&&window.ReactNativeWebView.postMessage)?function(t,e){window.ReactNativeWebView.postMessage(JSON.stringify(e?{type:t,payload:e}:{type:t}))}:function(t,e){const s={type:t,payload:e};switch(s.type){case"TaskError":case"TaskResult":alert(s.payload.message)}};function r(t){return e=>o(t,e)}const c=r("TaskStart"),l=r("TaskEnd"),u=r("TaskSuccess"),p=r("TaskError"),d=(r("TaskResult"),r("TaskStepStart")),w=r("TaskStepEnd"),h=r("TaskDelay");class f{static of(){return new this}static defaultFlowBuilderOptions(){return{delayTimeAfterEachStep:500}}static async delayAndNotify(t){h({delayTime:t}),await i(t)}steps=[];flowBuilderOptions=f.defaultFlowBuilderOptions();constructor(){}setFlowBuilderOptions(t){return this.flowBuilderOptions={...this.flowBuilderOptions,...t},this}step(t,e){return this.steps.push({stepName:e,fn:t}),this}delayStep(t=500,e="DelayStep"){return this.step((()=>f.delayAndNotify(t)),e)}loopStep(t,e,s="LoopStep"){return this.step((async()=>{for(;t();)await e()}),s)}waitClickStep(t,e){return this.step((()=>async function(t){s(await a(t))}(t)),e)}waitViewClickStep(t,e){return this.step((()=>n(t)),e)}build(){return async()=>{const{delayTimeAfterEachStep:t}=this.flowBuilderOptions;for(const[e,{stepName:s,fn:i}]of this.steps.entries()){const a={stepName:s,index:e};d(a),await i(),w(a),await f.delayAndNotify(t)}}}}class y extends f{urls;static of(t=[]){return new this(Array.isArray(t)?t:[t])}static defaultPageFlowOptions(){return{delayTimeBeforeTaskStart:1e3}}taskSuccessFn=()=>!1;pageFlowOptions=y.defaultPageFlowOptions();constructor(t){super(),this.urls=t}useTouchClick(){return s=e,this}setPageFlowOptions(t){return this.pageFlowOptions={...this.pageFlowOptions,...t},this}successWhen(t){return this.taskSuccessFn=t,this}successViewExists(e){return this.successWhen((()=>function(e){const s=t(e);return!!s&&(s.scrollIntoView({block:"center"}),!0)}(e)))}async execute(){if(c(),!this.validatePageUrl())return p({message:"PageInvalid"});if(await y.delayAndNotify(this.pageFlowOptions.delayTimeBeforeTaskStart),this.taskSuccessFn())return u();try{await this.build()(),this.taskSuccessFn()?u():l()}catch(t){p({message:t.message})}}validatePageUrl(){const t=this.urls,e=window.location.href;return!t.length||t.some((t=>e.startsWith(t)))}}y.of("https://prodev.m.jd.com/mall/active/").successViewExists(".sign_btn_dis").waitViewClickStep(".sign_btn","立即翻牌").delayStep(2e3).waitClickStep(".pop_close_icon","关闭Modal").execute().then()})();